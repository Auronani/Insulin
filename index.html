
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IOB Calculator (Mobile Auto-Refresh)</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f7f7f7;
    }
    h1 {
      font-size: 1.3rem;
      margin-bottom: 0.5rem;
    }
    .section {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    label { display:block; margin-top:0.5rem; font-size:0.9rem; }
    input {
      width: 100%;
      padding: 0.4rem;
      margin-top: 0.2rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size:1rem;
    }
    button {
      margin-top:0.5rem;
      padding:0.5rem 1rem;
      border:none;
      border-radius:6px;
      font-size:1rem;
      background:#007aff;
      color:white;
    }
    .dose-log { font-size:0.9rem; }
    .dose-log div { padding:0.2rem 0; border-bottom:1px solid #eee; }
    .highlight { font-weight:bold; font-size:1.2rem; }
  </style>
</head>
<body>
  <h1>IOB Calculator</h1>

  <div class="section">
    <label>Units (U): <input id="doseUnits" type="number" step="0.1" /></label>
    <label>Time: <input id="doseTime" type="datetime-local" /></label>
    <button onclick="addDose()">Add Dose</button>
  </div>

  <div class="section">
    <div>Current IOB: <span id="iobDisplay" class="highlight">0</span> U</div>
    <div>Suggested Correction: <span id="corrDisplay">0</span> U</div>
    <div>Suggested Meal Bolus: <span id="mealDisplay">0</span> U</div>
  </div>

  <div class="section">
    <h3>Settings</h3>
    <label>Target BG: <input id="target" type="number" value="120"></label>
    <label>ISF (mg/dL per 1U): <input id="isf" type="number" value="25"></label>
    <label>ICR (g per 1U): <input id="icr" type="number" value="25"></label>
    <label>DIA (hours): <input id="dia" type="number" value="3"></label>
    <label>Calibration %: <input id="calib" type="number" value="100"></label>
    <label>Carbs (g): <input id="carbs" type="number" value="0"></label>
    <label>Current BG: <input id="currentBG" type="number" value="0"></label>
  </div>

  <div class="section dose-log">
    <h3>Dose Log</h3>
    <div id="doseLog"></div>
    <button onclick="exportData()">Export</button>
    <button onclick="importData()">Import</button>
  </div>

  <script>
    const STORAGE_KEY_DOSES = "iob_doses_unified";
    const STORAGE_KEY_CFG = "iob_cfg_unified";
    let doses = JSON.parse(localStorage.getItem(STORAGE_KEY_DOSES)||"[]");

    function save() {
      localStorage.setItem(STORAGE_KEY_DOSES, JSON.stringify(doses));
      const cfg = {
        target: target.value,
        isf: isf.value,
        icr: icr.value,
        dia: dia.value,
        calib: calib.value
      };
      localStorage.setItem(STORAGE_KEY_CFG, JSON.stringify(cfg));
    }

    function loadCfg() {
      const cfg = JSON.parse(localStorage.getItem(STORAGE_KEY_CFG)||"{}");
      if(cfg.target) target.value = cfg.target;
      if(cfg.isf) isf.value = cfg.isf;
      if(cfg.icr) icr.value = cfg.icr;
      if(cfg.dia) dia.value = cfg.dia;
      if(cfg.calib) calib.value = cfg.calib;
    }

    function exponentialIOB(doseTime, units, now, diaHrs) {
      const tMin = (now - new Date(doseTime))/60000;
      const diaMin = diaHrs*60;
      if(tMin<0) return units;
      if(tMin>diaMin) return 0;
      // Jade-like exponential decay
      const frac = Math.exp(-tMin/(diaMin/Math.log(2))); 
      return units * frac;
    }

    function calcIOB() {
      const now = new Date();
      let diaHrs = parseFloat(dia.value);
      let calibPct = parseFloat(calib.value)/100;
      let total = 0;
      doses.forEach(d=>{
        total += exponentialIOB(d.time,d.units,now,diaHrs);
      });
      return total*calibPct;
    }

    function refresh() {
      let iob = calcIOB();
      iobDisplay.textContent = iob.toFixed(2);
      let bg = parseFloat(currentBG.value||0);
      let targetBG = parseFloat(target.value);
      let isfVal = parseFloat(isf.value);
      let icrVal = parseFloat(icr.value);
      let carbsVal = parseFloat(carbs.value||0);

      let correction = 0;
      if(bg>targetBG) correction = Math.floor((bg-targetBG)/isfVal);
      let meal = Math.floor(carbsVal/icrVal);

      corrDisplay.textContent = correction;
      mealDisplay.textContent = meal;

      // update dose log
      doseLog.innerHTML="";
      doses.forEach(d=>{
        let age = ((new Date()-new Date(d.time))/60000).toFixed(0);
        doseLog.innerHTML += `<div>${d.units}U at ${d.time} (${age} min ago)</div>`;
      });

      save();
    }

    function addDose() {
      const u = parseFloat(doseUnits.value);
      const t = doseTime.value? new Date(doseTime.value): new Date();
      if(!u) return;
      doses.push({units:u,time:t});
      doseUnits.value="";
      doseTime.value="";
      refresh();
    }

    function exportData() {
      const payload = {
        doses, cfg: {
          target: target.value,
          isf: isf.value,
          icr: icr.value,
          dia: dia.value,
          calib: calib.value
        }
      };
      navigator.clipboard.writeText(JSON.stringify(payload));
      alert("Export copied to clipboard.");
    }

    function importData() {
      const j = prompt("Paste export JSON here:");
      if(!j) return;
      try{
        const data = JSON.parse(j);
        doses = data.doses||[];
        if(data.cfg){
          target.value=data.cfg.target;
          isf.value=data.cfg.isf;
          icr.value=data.cfg.icr;
          dia.value=data.cfg.dia;
          calib.value=data.cfg.calib;
        }
        refresh();
      }catch(e){ alert("Bad JSON"); }
    }

    loadCfg();
    refresh();
    setInterval(refresh,15000); // auto-refresh
    document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) refresh(); });

    if("wakeLock" in navigator){
      navigator.wakeLock.request("screen").catch(()=>{});
    }
  </script>
</body>
</html>
